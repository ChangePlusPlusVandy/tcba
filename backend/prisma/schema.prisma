generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Announcements {
  id               String            @id @default(cuid())
  title            String
  content          String
  publishedDate    DateTime?
  isPublished      Boolean           @default(false)
  attachmentUrls   String[]
  createdByAdminId String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  slug             String            @unique
  AnnouncementTag  AnnouncementTag[]
  tags             Tag[]             @relation("AnnouncementsToTag")

  @@index([isPublished, createdAt(sort: Desc)])
  @@map("announcements")
}

model Tag {
  id              String            @id @default(cuid())
  name            String            @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  AnnouncementTag AnnouncementTag[]
  BlogTag         BlogTag[]
  announcements   Announcements[]   @relation("AnnouncementsToTag")
  blogs           Blog[]            @relation("BlogsToTag")

  @@map("tags")
}

model AnnouncementTag {
  announcementId String
  tagId          String
  announcement   Announcements @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  tag            Tag           @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([announcementId, tagId])
  @@map("_announcement_tags")
}

model BlogTag {
  blogId String
  tagId  String
  blog   Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([blogId, tagId])
  @@map("_blog_tags")
}

model Alert {
  id               String        @id @default(cuid())
  title            String
  content          String
  priority         AlertPriority @default(MEDIUM)
  publishedDate    DateTime?
  isPublished      Boolean       @default(false)
  attachmentUrls   String[]
  tags             String[]
  questions        Json @default("[]")
  responses        AlertResponse[]
  createdByAdminId String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@map("alerts")
}

model AlertResponse {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  responses      Json?
  alertId    String
  alert      Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  submittedDate  DateTime?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([alertId, organizationId])
  
  @@map("alert_responses")
}

model Organization {
  id                    String             @id @default(cuid())
  clerkId               String             @unique
  name                  String             @unique
  email                 String             @unique
  description           String?
  website               String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  latitude              Float?
  longitude             Float?
  primaryContactName    String
  primaryContactEmail   String
  primaryContactPhone   String
  secondaryContactName  String?
  secondaryContactEmail String?
  region                TennesseeRegion?
  organizationType      String?
  membershipActive      Boolean            @default(false)
  membershipDate        DateTime?
  membershipRenewalDate DateTime?
  organizationSize      OrganizationSize
  role                  OrganizationRole   @default(MEMBER)
  status                OrganizationStatus @default(PENDING)
  tags                  String[]
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  notifyAlerts               Boolean            @default(true)
  notifyAnnouncements        Boolean            @default(true)
  notifyBlogs                Boolean            @default(true)
  notifySurveys              Boolean            @default(true)
  visibleInDirectory         Boolean            @default(true)
  lastCheckedAlertsAt        DateTime?
  lastCheckedAnnouncementsAt DateTime?
  lastCheckedBlogsAt         DateTime?
  lastCheckedMessagesAt      DateTime?
  surveyResponses            SurveyResponse[]
  subscription               Subscription?
  conversations              Conversation[]          @relation("OrgConversations")
  sentMessages               Message[]               @relation("SentMessages")
  otherConversations         Conversation[]          @relation("OrgToOrgConversations")
  eventRSVPs                 EventRSVP[]             @relation("EventRSVPs")
  AlertResponse               AlertResponse[]

  @@map("organizations")
}

model SurveyResponse {
  id             String       @id @default(cuid())
  responses      Json?
  submittedDate  DateTime?
  surveyId       String
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  survey         Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@unique([surveyId, organizationId])
  @@map("surveyResponse")
}

model Survey {
  id              String           @id @default(cuid())
  title           String
  description     String?
  questions       Json
  dueDate         DateTime?
  isActive        Boolean          @default(false)
  isPublished     Boolean          @default(false)
  status          SurveyStatus     @default(DRAFT)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  surveyResponses SurveyResponse[]

  @@map("surveys")
}

model AdminUser {
  id             String         @id @default(cuid())
  clerkId        String         @unique
  email          String
  name           String
  isSuperAdmin   Boolean        @default(false)
  isActive       Boolean
  conversations  Conversation[] @relation("AdminConversations")
  sentMessages   Message[]      @relation("SentMessages")
  createdEvents  Event[]        @relation("CreatedEvents")

  @@map("AdminUser")
}

model EmailSubscription {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  subscriptionTypes String[]
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("emailSubscriptions")
}

model Blog {
  id               String    @id @default(cuid())
  title            String
  content          String
  author           String
  featuredImageUrl String?
  isPublished      Boolean   @default(false)
  publishedDate    DateTime?
  attachmentUrls   String[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  slug             String    @unique
  BlogTag          BlogTag[]
  tags             Tag[]     @relation("BlogsToTag")

  @@index([isPublished, publishedDate(sort: Desc)])
  @@map("blogs")
}

model Notification {
  id            String           @id @default(cuid())
  type          NotificationType
  title         String
  contentId     String
  createdAt     DateTime         @default(now())
  lastCheckedAt DateTime?

  @@map("notifications")
}

model EmailHistory {
  id               String      @id @default(cuid())
  subject          String
  body             String
  recipientEmails  String[]
  recipientCount   Int
  filters          Json?
  scheduledFor     DateTime?
  sentAt           DateTime?
  status           EmailStatus @default(SCHEDULED)
  createdByAdminId String
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@map("email_history")
}

model PageContent {
  id           String   @id @default(cuid())
  page         String
  section      String
  contentKey   String
  contentValue String
  contentType  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([page, section, contentKey])
  @@index([page])
  @@map("page_content")
}

model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String             @unique
  organization         Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stripeCustomerId     String
  stripeSubscriptionId String             @unique
  stripePriceId        String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  payments             Payment[]
  invoices             Invoice[]
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([organizationId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model Payment {
  id                    String        @id @default(cuid())
  subscriptionId        String
  subscription          Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  stripePaymentIntentId String        @unique
  stripeInvoiceId       String?
  amount                Int           // Amount in cents
  currency              String        @default("usd")
  status                PaymentStatus
  paymentMethod         String?
  receiptUrl            String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@map("payments")
}

model Invoice {
  id               String       @id @default(cuid())
  subscriptionId   String
  subscription     Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  stripeInvoiceId  String       @unique
  amount           Int          // Amount in cents
  currency         String       @default("usd")
  status           String
  invoicePdf       String?
  hostedInvoiceUrl String?
  periodStart      DateTime
  periodEnd        DateTime
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

model Conversation {
  id                   String           @id @default(cuid())
  type                 ConversationType
  organizationId       String?
  organization         Organization?    @relation("OrgConversations", fields: [organizationId], references: [id], onDelete: Cascade)
  adminId              String?
  admin                AdminUser?       @relation("AdminConversations", fields: [adminId], references: [id], onDelete: Cascade)
  otherOrganizationId  String?
  otherOrganization    Organization?    @relation("OrgToOrgConversations", fields: [otherOrganizationId], references: [id], onDelete: Cascade)
  subject              String
  lastMessageAt        DateTime         @default(now())
  messages             Message[]
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  @@index([organizationId])
  @@index([adminId])
  @@index([otherOrganizationId])
  @@index([lastMessageAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id                   String        @id @default(cuid())
  conversationId       String
  conversation         Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType           String        // "ORG" or "ADMIN"
  senderOrganizationId String?
  senderOrganization   Organization? @relation("SentMessages", fields: [senderOrganizationId], references: [id], onDelete: Cascade)
  senderAdminId        String?
  senderAdmin          AdminUser?    @relation("SentMessages", fields: [senderAdminId], references: [id], onDelete: Cascade)
  content              String        @db.Text
  attachments          String[]
  status               MessageStatus @default(SENT)
  readAt               DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@index([conversationId])
  @@index([senderOrganizationId])
  @@index([senderAdminId])
  @@index([createdAt(sort: Desc)])
  @@map("messages")
}

model Event {
  id               String      @id @default(cuid())
  title            String
  description      String      @db.Text
  location         String?
  link         String?
  meetingPassword  String?
  startTime        DateTime
  endTime          DateTime
  timezone         String      @default("America/Chicago")
  status           EventStatus @default(DRAFT)
  maxAttendees     Int?
  createdByAdminId String
  createdByAdmin   AdminUser   @relation("CreatedEvents", fields: [createdByAdminId], references: [id], onDelete: Cascade)
  tags             String[]
  attachments      String[]
  rsvps            EventRSVP[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([createdByAdminId])
  @@index([startTime])
  @@index([status])
  @@map("events")
}

model EventRSVP {
  id                  String       @id @default(cuid())
  eventId             String
  event               Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organizationId      String
  organization        Organization @relation("EventRSVPs", fields: [organizationId], references: [id], onDelete: Cascade)
  status              RSVPStatus
  attendeeName        String?
  attendeeEmail       String?
  attendeePhone       String?
  reminder3DaysSent   Boolean      @default(false)
  reminder1DaySent    Boolean      @default(false)
  reminder1HourSent   Boolean      @default(false)
  notes               String?      @db.Text
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@unique([eventId, organizationId])
  @@index([eventId])
  @@index([organizationId])
  @@index([status])
  @@map("event_rsvps")
}

enum EmailStatus {
  SCHEDULED
  SENT
  FAILED
}

enum OrganizationRole {
  ADMIN
  MEMBER
}

enum OrganizationStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum TennesseeRegion {
  EAST
  MIDDLE
  WEST
}

enum OrganizationSize {
  SMALL
  MEDIUM
  LARGE
  EXTRA_LARGE
}

enum AlertPriority {
  URGENT
  LOW
  MEDIUM
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  CLOSED
  ARCHIVED
}

enum NotificationType {
  BLOG
  ANNOUNCEMENT
  ALERT
  SURVEY
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum ConversationType {
  ORG_TO_ORG
  ORG_TO_ADMIN
  ADMIN_TO_ORG
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum RSVPStatus {
  GOING
  NOT_GOING
  MAYBE
}
